{% extends "user_authorization/base.html" %}
{% block content %}
<div class="shadow-wrap" xmlns="http://www.w3.org/1999/html">
        <div class="form-wrap">
            <h2>Forgot Password</h2>
        <form id="forgot-password-form">
            {% csrf_token %}
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" placeholder="{{ email|default:'Enter your email' }}" required>
                <span id="email-status" class="status-icon"></span>
            </div>

            <div class="form-group">
                <label for="otp">Enter OTP</label>
                <input type="text" id="otp" name="otp" placeholder="Enter OTP">
            </div>
        </div>
            <div class="button-group">
                <button type="submit" class="submit-btn-reset" id="send-otp-btn" name="send">Send OTP</button>
                <button type="submit" class="submit-btn-reset" id="verify-btn" name="verify" style="display: none;">Verify OTP</button>
            </div>
        </form>
        <div id="message"></div>
</div>

    <script>
        const forgotPasswordForm = document.getElementById('forgot-password-form');
        const emailInput = document.getElementById('email');
        const emailStatus = document.getElementById('email-status');
        const sendOtpBtn = document.getElementById('send-otp-btn');
        const verifyBtn = document.getElementById('verify-btn');
        let resendOtpBtn;

        // Email validation regex
        function validateEmail(email) {
            const regex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
            return regex.test(email);
        }

        // Event listener for email input
        emailInput.addEventListener('input', function() {
            if (validateEmail(emailInput.value)) {
                emailStatus.textContent = '✅';
                emailStatus.style.color = 'green';
            } else {
                emailStatus.textContent = '❌';
                emailStatus.style.color = 'red';
            }
        });

        // Event listener for "Send OTP" button
        function button_change() {
            // Change button text from "Send" to "Resend"
            sendOtpBtn.textContent = 'Resend OTP';
            sendOtpBtn.name = 'resend';
            verifyBtn.style.display = 'block'; // Show Verify button after OTP is sent
            sendOtpBtn.disabled = true; //disable the "Send OTP" button for some time before allowing to resend
            setTimeout(function() {
                sendOtpBtn.disabled = false;
            }, 10000)
        };

    forgotPasswordForm.addEventListener('submit', function(event) {
        event.preventDefault();  // Prevent form from reloading the page
        const formData = new FormData(forgotPasswordForm);
        let action;
        action=event.submitter.name

        const email = formData.get('email');  // Get email field value
        const otp = formData.get('otp');
        console.log(email)
        console.log(otp)
        console.log(action)
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Determine action based on button clicked
        let postData = {};

        if (action === 'send') {
            postData = {
                email: email,
                action: 'send_otp' };
        } else if (action === 'resend') {
            postData = {
                email: email,
                action: 'resend_otp' };
        } else if (action === 'verify'){
            postData = {
                email: email,
                otp: otp,
                action: 'verify_otp' };
        }

        // Send AJAX request to server
        fetch("{% url 'password_reset' %}", {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify(postData),
            })
            .then(response => response.json())
            .then(data => {
                const messageDiv = document.getElementById('message');
                if(data.error){
                    messageDiv.innerHTML = `<p style="color: red;">${data.message}</p>`;
                } else{
                    if (data.success) {
                        button_change()
                        messageDiv.innerHTML = `<p style="color: #06c843;">${data.message}</p>`;
                    } else {
                        messageDiv.innerHTML = `<p style="color: red;">${data.message}</p>`;
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    </script>
    {% endblock content %}
